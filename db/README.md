# ScholarSphere Database

Written by Clayton Durepos

This directory contains all database-related files for the ScholarSphere application, including schemas, stored procedures, functions, and events.

## Directory Structure

```
db/
├── schema/          # Table definitions
├── procedures/     # Stored procedures (CRUD operations, workflows)
├── functions/      # Stored functions (reusable SQL functions)
├── events/         # Scheduled database events
└── init/          # Initialization scripts (generated)
```

## Schema (`schema/`)

This directory contains the blueprint for each table required by and utilized in the ScholarSphere application.

### Attribute Typing

- **IDs**: Generated pre-insertion. Standard UUID generation is 36 characters, thus we utilize the datatype `CHAR(36)` for all IDs.
- **Large text**: Default to `VARCHAR(2048)`. The `TEXT` attribute allows up to `65,535` characters, so we avoid this to limit storage requirements.
- **Standard text**: Default to `VARCHAR(255)` for attributes where appropriate.

### Naming Convention

- **Entity tables**: Schema files are named after the entity they outline (e.g., `faculty.sql`, `institution.sql`).
- **Join/relationship tables**: Follow the naming convention `{entity1}_{relationship}_{entity2}.sql` (e.g., `faculty_works_at_institution.sql`).
- **Multivalued attributes**: Follow the naming convention `{entity}_{property}.sql` (e.g., `faculty_email.sql`, `faculty_department.sql`).
- **Relationship names**: Follow snake_case (all lowercase letters with underscores substituted for spaces).

## Procedures (`procedures/`)

This directory contains all `*.sql` scripts for stored procedures of the ScholarSphere application.

### Organization

Procedures are organized into subdirectories:

- **`create/`** - Procedures for creating new records
- **`read/`** - Procedures for reading/querying records
- **`update/`** - Procedures for updating existing records
- **`delete/`** - Procedures for deleting records
- **`workflow/`** - Complex business logic procedures (recommendations, search, validation)
- **`util/`** - Utility procedures (e.g., normalization functions)

### Naming Conventions

#### File Names

The majority of procedures follow the naming convention:

```
{create | read | update | delete}_{table_name}.sql
```

Read operations follow the naming convention:

```
read_{table_name}_by_{filter}.sql
```

For example:
- `read_faculty_works_at_institution_by_faculty.sql` - Returns institutions for a given faculty member
- `read_faculty_works_at_institution_by_institution.sql` - Returns faculty members for a given institution

#### Variable Prefixes

In each script, we utilize variable prefixes to clarify their role and to avoid naming collisions within the DB:

- `v_` - Local variable
- `p_` - Parameter

**Example:**
```sql
CREATE PROCEDURE example_procedure(IN p_faculty_id CHAR(36))
BEGIN
    DECLARE v_count INT;
    -- Procedure logic here
END
```

## Functions (`functions/`)

This directory contains all `*.sql` scripts for stored functions of the ScholarSphere application.

Stored functions are reusable SQL functions that return a single value and can be used in SQL expressions.

### Naming Conventions

Variable prefixes follow the same convention as procedures:

- `v_` - Local variable
- `p_` - Parameter

**Example functions:**
- `hash_password(p_password)` - Hash a password for storage
- `keyword_exists(p_keyword_name)` - Check if a keyword exists
- `get_publication_year(p_publication_id)` - Extract year from publication
- `normalize_department_name(p_dept_name)` - Normalize department name for matching

## Events (`events/`)

This directory holds the stored events for our database.

Events are re-occurring procedures often used for cleaning the database or updating calculated information.

**Example events:**
- `clean_session_event.sql` - Periodically clean expired sessions
- `clean_faculty_generates_keyword_event.sql` - Clean temporary keyword generation data
- `generate_recommendations_event.sql` - Periodically regenerate recommendations

## Initialization Scripts (`init/`)

The `init/` directory contains generated SQL scripts that initialize the entire database:

- `000_create_database.sql` - Creates the database
- `001_init_schema.sql` - Creates all tables (generated from `schema/`)
- `002_init_procedures.sql` - Creates all stored procedures (generated from `procedures/`)
- `003_init_functions.sql` - Creates all stored functions (generated from `functions/`)
- `004_init_events.sql` - Creates all events (generated from `events/`)

These files are generated by the corresponding `generate_*.sh` scripts in the `db/` directory.

## Generation Scripts

The following shell scripts generate the initialization files:

- `generate_schema.sh` - Generates `001_init_schema.sql` from `schema/` directory
- `generate_procedures.sh` - Generates `002_init_procedures.sql` from `procedures/` directory
- `generate_functions.sh` - Generates `003_init_functions.sql` from `functions/` directory
- `generate_events.sh` - Generates `004_init_events.sql` from `events/` directory

Run these scripts after making changes to schema, procedures, functions, or events to regenerate the initialization files.

